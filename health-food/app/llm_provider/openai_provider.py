import base64
import json
import os
from typing import Any, Dict, List

from agents import Agent, Runner
from openai import OpenAI

from .base import BaseLLMProvider


class OpenAIProvider(BaseLLMProvider):
    def __init__(self):
        self.client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        self.assistant_id = os.getenv("OPENAI_ASSISTANT_ID")
        self.nutrition_agent = self._create_nutrition_agent()
        self.recipe_agent = self._create_recipe_agent()

    def _create_nutrition_agent(self):
        """–°–æ–∑–¥–∞–µ—Ç –∞–≥–µ–Ω—Ç–∞ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –¥–æ–±–∞–≤–∫–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–æ–≤"""
        return Agent(
            name="AI-–î–∏–µ—Ç–æ–ª–æ–≥",
            instructions="""–¢—ã –æ–ø—ã—Ç–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥ –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∏–∏. 
            
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–∏—Ç–∞–º–∏–Ω–∞–º, –º–∏–Ω–µ—Ä–∞–ª–∞–º –∏ –ø–∏—Ç–∞–Ω–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–æ–≤ –∫—Ä–æ–≤–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            
            –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
            1. üìä –ê–ù–ê–õ–ò–ó–ò–†–£–ô –î–ê–ù–ù–´–ï: –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π. –£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º—ã.
            
            2. üéØ –ü–†–ò–û–†–ò–¢–ï–ó–ò–†–£–ô: –í—ã–¥–µ–ª–∏ 2-3 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –¥–µ—Ñ–∏—Ü–∏—Ç–∞/–ø—Ä–æ–±–ª–µ–º—ã. –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
            
            3. üíä –ö–û–ù–ö–†–ï–¢–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
               - –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–∫–∏
               - –î–æ–∑–∏—Ä–æ–≤–∫–∞ (—Å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º)
               - –õ—É—á—à–∞—è —Ñ–æ—Ä–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Ü–∏—Ç—Ä–∞—Ç –º–∞–≥–Ω–∏—è", "–º–µ—Ç–∏–ª–∫–æ–±–∞–ª–∞–º–∏–Ω B12")
               - –ö–æ–≥–¥–∞ –∏ –∫–∞–∫ –ø—Ä–∏–Ω–∏–º–∞—Ç—å
               - –° —á–µ–º –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –∏–∑–±–µ–≥–∞—Ç—å
            
            4. üçé –ü–ò–¢–ê–ù–ò–ï –ü–ï–†–í–ò–ß–ù–û: –í—Å–µ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–π –ø—Ä–æ–¥—É–∫—Ç—ã-–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–∫–∞–º–∏.
            
            5. ‚ö†Ô∏è –°–í–Ø–ó–¨ –° –°–ò–ú–ü–¢–û–ú–ê–ú–ò: –û–±—ä—è—Å–Ω—è–π, –∫–∞–∫–∏–µ —Å–∏–º–ø—Ç–æ–º—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã —Å –¥–µ—Ñ–∏—Ü–∏—Ç–∞–º–∏ (—É—Å—Ç–∞–ª–æ—Å—Ç—å, –≤—ã–ø–∞–¥–µ–Ω–∏–µ –≤–æ–ª–æ—Å, –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–∂–µ–π –∏ —Ç.–¥.).
            
            6. üìÖ –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô: –ü—Ä–µ–¥–ª–æ–∂–∏ —á–µ—Ç–∫–∏–π –ø–ª–∞–Ω - —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å, —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü, —á–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞.
            
            7. ‚öñÔ∏è –ë–ê–õ–ê–ù–°: –£—á–∏—Ç—ã–≤–∞–π –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∂–µ–ª–µ–∑–æ –ª—É—á—à–µ —Å –≤–∏—Ç–∞–º–∏–Ω–æ–º C, –Ω–æ –Ω–µ —Å –∫–∞–ª—å—Ü–∏–µ–º).
            
            8. üî¨ –ú–ï–î–ò–¶–ò–ù–°–ö–ê–Ø –û–ì–û–í–û–†–ö–ê: –í—Å–µ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –≤—Ä–∞—á–æ–º, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö.
            
            9. üí¨ –¢–û–ù–ê–õ–¨–ù–û–°–¢–¨: –ò—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π —Ç–æ–Ω. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º, –∏–∑–±–µ–≥–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞.
            
            10. üìù –§–û–†–ú–ê–¢: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Å —ç–º–æ–¥–∑–∏ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏, –Ω–æ –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ markdown).
            
            –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–Ω–∞–ª–∏–∑–∞—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.
            """,
            model="gpt-4o",
        )

    def _create_recipe_agent(self):
        """–°–æ–∑–¥–∞–µ—Ç –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤."""
        return Agent(
            name="AI-–®–µ—Ñ-–ø–æ–≤–∞—Ä",
            instructions="""–¢—ã ‚Äî AI-–¥–∏–µ—Ç–æ–ª–æ–≥ –∏ —à–µ—Ñ-–ø–æ–≤–∞—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 3 —Ä–µ—Ü–µ–ø—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. 
            
            –°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê:
            1.  **–ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –î–û–°–¢–£–ü–ù–´–ï –ü–†–û–î–£–ö–¢–´:** –†–µ—Ü–µ–ø—Ç—ã –¥–æ–ª–∂–Ω—ã —Å–æ—Å—Ç–æ—è—Ç—å –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –∏–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –≤ `user_context.preferences.available`. –ù–ï –î–û–ë–ê–í–õ–Ø–ô –Ω–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤, –∫—Ä–æ–º–µ –±–∞–∑–æ–≤—ã—Ö —Å–ø–µ—Ü–∏–π (—Å–æ–ª—å, –ø–µ—Ä–µ—Ü).
            2.  **–£–ß–ò–¢–´–í–ê–ô –ê–ù–ê–õ–ò–ó–´ –ò –ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–Ø:** –†–µ—Ü–µ–ø—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω—ã —Å —É—á–µ—Ç–æ–º –∞–Ω–∞–ª–∏–∑–æ–≤ (`labs`) –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –¥–∏–µ—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º (`preferences`).
            3.  **–°–û–ë–õ–Æ–î–ê–ô –°–õ–û–ñ–ù–û–°–¢–¨:** –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (`difficulty`) –¥–æ–ª–∂–µ–Ω –æ—Ç—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Ä–µ—Ü–µ–ø—Ç–∞—Ö.
            4.  **–°–¢–†–û–ì–ò–ô JSON –§–û–†–ú–ê–¢:** –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –ø–æ—è—Å–Ω–µ–Ω–∏–π –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ. JSON-–æ–±—ä–µ–∫—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–¥–∏–Ω –∫–ª—é—á `recipes`, –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–≥–æ ‚Äî —ç—Ç–æ —Å–ø–∏—Å–æ–∫ –∏–∑ –¢–†–Å–• –æ–±—ä–µ–∫—Ç–æ–≤-—Ä–µ—Ü–µ–ø—Ç–æ–≤. –ù–µ—Å–æ–±–ª—é–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ —Å–¥–µ–ª–∞–µ—Ç —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã–º.
            5.  **–ü–ò–®–ò –¢–û–õ–¨–ö–û –î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–´–ï –†–ï–¶–ï–ü–¢–´:** –ù–µ –ø–∏—à–∏ —Ä–µ—Ü–µ–ø—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å, –∏–ª–∏ —Ç–µ —á—Ç–æ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∞–Ω–∞–ª–∏–∑—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ —Ç–∞–∫ –∂–µ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –±—É–¥—É—Ç –Ω–µ –æ—á–µ–Ω—å –∫–∞–∫ –ø–æ –≤–∫—É—Å—É —Ç–∞–∫ –∏ –ø–æ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏.
            6.  **–ü–û–õ–Ø –†–ï–¶–ï–ü–¢–ê:** –ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç-—Ä–µ—Ü–µ–ø—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–∏:
                - `id` (string): –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'ai_recipe_123').
                - `name` (string): –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
                - `time_min` (integer): –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö.
                - `description` (string): –ö—Ä–∞—Ç–∫–æ–µ, –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
                - `ingredients` (list of objects): –°–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –∏–∑ –î–û–°–¢–£–ü–ù–´–• –ø—Ä–æ–¥—É–∫—Ç–æ–≤ `{'name': '...', 'amount': '...'}`.
                - `instructions` (list of strings): –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è.
                - `tags` (list of strings): –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å —Ç–µ–≥–∏ 'ai_generated', —Ç–µ–≥ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ('–ª—ë–≥–∫–∏–π', '—Å—Ä–µ–¥–Ω–∏–π' –∏–ª–∏ '—Å–ª–æ–∂–Ω—ã–π') –∏ –Ω—É–∂–µ–Ω —Ç–µ–≥ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å, –∫–∞–∫–æ–π\–∫–∞–∫ –≤–∏—Ç–∞–º–∏–Ω –±—É–¥–µ—Ç –≤ —Ä–µ—Ü–µ–ø—Ç–µ.
                
            7.  **–õ–æ–≥–∏–∫–∞:**
                *   **–£—á–∏—Ç—ã–≤–∞–π –±–∏–æ–º–∞—Ä–∫–µ—Ä—ã:** –ï—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç—ã, –≤–∫–ª—é—á–∞–π –≤ —Ä–µ—Ü–µ–ø—Ç—ã –ø—Ä–æ–¥—É–∫—Ç—ã, –±–æ–≥–∞—Ç—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –≤–∏—Ç–∞–º–∏–Ω–∞–º–∏ –∏ –º–∏–Ω–µ—Ä–∞–ª–∞–º–∏. –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–±—ã—Ç–∫–∏ ‚Äî –∏–∑–±–µ–≥–∞–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∏—Ö —É—Å—É–≥—É–±–∏—Ç—å.
                *   **–°–ª–µ–¥—É–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º:** –£—á–∏—Ç—ã–≤–∞–π –¥–∏–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–≤–µ–≥–∞–Ω, –±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞ –∏ —Ç.–¥.) –∏ –≤–∫—É—Å–æ–≤—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
                *   **–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–¥—É–∫—Ç—ã:** –û—Å–Ω–æ–≤–æ–π —Ä–µ—Ü–µ–ø—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –±–∞–∑–æ–≤—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (—Å–æ–ª—å, –ø–µ—Ä–µ—Ü, –º–∞—Å–ª–æ, —Å–ø–µ—Ü–∏–∏), –Ω–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞.
                *   **–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –†–µ—Ü–µ–ø—Ç—ã –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —É—Ä–æ–≤–Ω—é —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:
                    *   **–ª–µ–≥–∫–∏–π:** –ë—ã—Å—Ç—Ä—ã–µ –∏ –ø—Ä–æ—Å—Ç—ã–µ –±–ª—é–¥–∞ (–¥–æ 30 –º–∏–Ω), –º–∏–Ω–∏–º—É–º —à–∞–≥–æ–≤.
                    *   **—Å—Ä–µ–¥–Ω–∏–π:** –ë–æ–ª–µ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã (30-60 –º–∏–Ω) —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —ç—Ç–∞–ø–∞–º–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è.
                    *   **—Å–ª–æ–∂–Ω—ã–π:** –ò–∑—ã—Å–∫–∞–Ω–Ω—ã–µ –±–ª—é–¥–∞ (–æ—Ç 60 –º–∏–Ω), —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è –∫ –¥–µ—Ç–∞–ª—è–º –∏ —Ç–µ—Ö–Ω–∏–∫–∞–º.
            """,
            model="gpt-4o-mini",
        )

    async def analyze_image(self, image_data: bytes, prompt: str) -> List[str]:
        base64_image = base64.b64encode(image_data).decode("utf-8")
        try:
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {
                        "role": "user",
                        "content": [
                            {"type": "text", "text": prompt},
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": f"data:image/jpeg;base64,{base64_image}"
                                },
                            },
                        ],
                    }
                ],
            )
            content = response.choices[0].message.content
            if content:
                if content.startswith("```json"):
                    content = content[7:-3]
                data = json.loads(content)
                return data.get("items", [])
        except Exception as e:
            print(f"Failed to analyze image with OpenAI: {e}")
        return []
        # return [
        #     "–æ–≤—Å—è–Ω–∫–∞",
        #     "—è–π—Ü–∞",
        #     "—Ä—ã–±–∞",
        #     "—è–±–ª–æ–∫–∏",
        #     "–æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ",
        #     "–∫—É–∫—É—Ä—É–∑–∞",
        #     "—Ä–∏—Å",
        #     "—Ç–æ–º–∞—Ç—ã",
        #     "—à–ø–∏–Ω–∞—Ç",
        # ]

    # async def get_assistant_response(
    #     self, thread_id: str, user_message: str, user_context: dict
    # ) -> dict:
    #     if not self.assistant_id:
    #         return {"error": "Assistant ID not configured"}

    #     if not thread_id:
    #         full_message = (
    #             f"–í–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:\n{json.dumps(user_context, indent=2, ensure_ascii=False)}\n\n"
    #             f"–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}"
    #         )
    #         thread = self.client.beta.threads.create(
    #             messages=[{"role": "user", "content": full_message}]
    #         )
    #         thread_id = thread.id
    #     else:
    #         self.client.beta.threads.messages.create(
    #             thread_id=thread_id, role="user", content=user_message
    #         )

    #     run = self.client.beta.threads.runs.create(
    #         thread_id=thread_id, assistant_id=self.assistant_id
    #     )

    #     while run.status not in ["completed", "failed"]:
    #         time.sleep(1)
    #         run = self.client.beta.threads.runs.retrieve(
    #             thread_id=thread_id, run_id=run.id
    #         )

    #     if run.status == "failed":
    #         return {"error": "Assistant run failed."}

    #     messages = self.client.beta.threads.messages.list(thread_id=thread_id)

    #     assistant_reply = "No response from assistant."
    #     if messages.data and messages.data[0].content:
    #         assistant_reply = messages.data[0].content[0].text.value

    #     return {"reply": assistant_reply, "thread_id": thread_id}

    async def generate_recipes(
        self, user_context: Dict[str, Any]
    ) -> List[Dict[str, Any]]:
        try:
            prompt = (
                "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Ä–µ—Ü–µ–ø—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
                f"{json.dumps(user_context, indent=2, ensure_ascii=False)}\n\n"
                "–°–ª–µ–¥—É–π –º–æ–∏–º —Å–∏—Å—Ç–µ–º–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –∏ –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON."
            )

            result = await Runner.run(self.recipe_agent, prompt)
            content = result.final_output

            if content:
                if content.startswith("```json"):
                    content = content[7:-3]

                data = json.loads(content)
                return data.get("recipes", [])

            return []
        except Exception as e:
            print(f"Failed to generate recipes with agent: {e}")
            return []
        # return [
        #     {
        #         "id": "1",
        #         "name": "–û–≤—Å—è–Ω–∫–∞ —Å —è–π—Ü–∞–º–∏",
        #         "time_min": 10,
        #         "description": "–õ–µ–≥–∫–∏–π –∑–∞–≤—Ç—Ä–∞–∫ —Å –±–æ–≥–∞—Ç—ã–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º –±–µ–ª–∫–∞ –∏ –∫–ª–µ—Ç—á–∞—Ç–∫–∏",
        #     },
        #     {
        #         "id": "2",
        #         "name": "–†—ã–±–∞ —Å —Ä–∏—Å–æ–º",
        #         "time_min": 20,
        #         "description": "–ü–∏—Ç–∞—Ç–µ–ª—å–Ω–æ–µ –±–ª—é–¥–æ —Å –≤—ã—Å–æ–∫–∏–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º –±–µ–ª–∫–∞ –∏ –æ–º–µ–≥–∞-3",
        #     },
        #     {
        #         "id": "3",
        #         "name": "–Ø–±–ª–æ–∫–∏ —Å –æ–ª–∏–≤–∫–æ–≤—ã–º –º–∞—Å–ª–æ–º",
        #         "time_min": 5,
        #         "description": "–õ–µ–≥–∫–∏–π –ø–µ—Ä–µ–∫—É—Å —Å –±–æ–≥–∞—Ç—ã–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º –∫–ª–µ—Ç—á–∞—Ç–∫–∏ –∏ –≤–∏—Ç–∞–º–∏–Ω–∞ C",
        #     },
        # ]

    async def get_vitamin_recommendations(
        self, user_message: str, thread_id: str, user_context: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–∏—Ç–∞–º–∏–Ω–∞–º –æ—Ç –∞–≥–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            thread_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–∞ –∏–ª–∏ None –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
            user_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–Ω–∞–ª–∏–∑—ã, –¥–µ—Ñ–∏—Ü–∏—Ç—ã, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è)

        Returns:
            Dict —Å –æ—Ç–≤–µ—Ç–æ–º –∞–≥–µ–Ω—Ç–∞ –∏ id –¥–∏–∞–ª–æ–≥–∞
        """
        try:
            prompt = f"""
            –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:
            –ê–Ω–∞–ª–∏–∑—ã: {json.dumps(user_context.get("labs", {}), ensure_ascii=False)}
            –î–µ—Ñ–∏—Ü–∏—Ç—ã: {json.dumps(user_context.get("deficits", {}), ensure_ascii=False)}
            –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: {json.dumps(user_context.get("preferences", {}), ensure_ascii=False)}
            
            –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}
            """

            result = await Runner.run(self.nutrition_agent, prompt)

            return {
                "reply": result.final_output,
                "thread_id": thread_id or "nutrition-agent",
            }
        except Exception as e:
            print(f"Error in vitamins recommendations: {str(e)}")
            raise e
